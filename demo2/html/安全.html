<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">安全</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><p>GORM 使用 <code>database/sql</code> 的参数占位符来构造 SQL 语句，这可以自动转义参数，避免 SQL 注入数据</p><blockquote class="note warn"><p><strong>注意</strong> Logger 打印的 SQL 并不像最终执行的 SQL 那样已经转义，复制和运行这些 SQL 时应当注意。</p></blockquote><h2 id="查询条件" class="article-heading"><a href="#查询条件" class="headerlink" title="查询条件"></a>查询条件<a class="article-anchor" href="#查询条件" aria-hidden="true"></a></h2><p>用户的输入只能作为参数，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">userInput := <span class="string">"jinzhu;drop table users;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全的，会被转义</span></span><br><span class="line">db.Where(<span class="string">"name = ?"</span>, userInput).First(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQL 注入</span></span><br><span class="line">db.Where(fmt.Sprintf(<span class="string">"name = %v"</span>, userInput)).First(&amp;user)</span><br></pre></td></tr></tbody></table></figure><h2 id="内联条件" class="article-heading"><a href="#内联条件" class="headerlink" title="内联条件"></a>内联条件<a class="article-anchor" href="#内联条件" aria-hidden="true"></a></h2><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 会被转义</span></span><br><span class="line">db.First(&amp;user, <span class="string">"name = ?"</span>, userInput)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQL 注入</span></span><br><span class="line">db.First(&amp;user, fmt.Sprintf(<span class="string">"name = %v"</span>, userInput))</span><br></pre></td></tr></tbody></table></figure><p>当通过用户输入的整形主键检索记录时，你应该对变量进行类型检查。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">userInputID := <span class="string">"1=1;drop table users;"</span></span><br><span class="line"><span class="comment">// 安全的，返回 err</span></span><br><span class="line">id,err := strconv.Atoi(userInputID)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> error</span><br><span class="line">}</span><br><span class="line">db.First(&amp;user, id)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQL 注入</span></span><br><span class="line">db.First(&amp;user, userInputID)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE 1=1;drop table users;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="SQL-注入方法" class="article-heading"><a href="#SQL-注入方法" class="headerlink" title="SQL 注入方法"></a>SQL 注入方法<a class="article-anchor" href="#SQL-注入方法" aria-hidden="true"></a></h2><p>为了支持某些功能，一些输入不会被转义，调用方法时要小心用户输入的参数。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Select(<span class="string">"name; drop table users;"</span>).First(&amp;user)</span><br><span class="line">db.Distinct(<span class="string">"name; drop table users;"</span>).First(&amp;user)</span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Pluck(<span class="string">"name; drop table users;"</span>, &amp;names)</span><br><span class="line"></span><br><span class="line">db.Group(<span class="string">"name; drop table users;"</span>).First(&amp;user)</span><br><span class="line"></span><br><span class="line">db.Group(<span class="string">"name"</span>).Having(<span class="string">"1 = 1;drop table users;"</span>).First(&amp;user)</span><br><span class="line"></span><br><span class="line">db.Raw(<span class="string">"select name from users; drop table users;"</span>).First(&amp;user)</span><br><span class="line"></span><br><span class="line">db.Exec(<span class="string">"select name from users; drop table users;"</span>)</span><br><span class="line"></span><br><span class="line">db.Order(<span class="string">"name; drop table users;"</span>).First(&amp;user)</span><br></pre></td></tr></tbody></table></figure><p>避免 SQL 注入的一般原则是，不信任用户提交的数据。您可以进行白名单验证来测试用户的输入是否为已知安全的、已批准、已定义的输入，并且在使用用户的输入时，仅将它们作为参数。</p></body></html>              </div>
<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">更新</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="保存所有字段" class="article-heading"><a href="#保存所有字段" class="headerlink" title="保存所有字段"></a>保存所有字段<a class="article-anchor" href="#保存所有字段" aria-hidden="true"></a></h2><p><code>Save</code> 会保存所有的字段，即使字段是零值</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.First(&amp;user)</span><br><span class="line"></span><br><span class="line">user.Name = <span class="string">"jinzhu 2"</span></span><br><span class="line">user.Age = <span class="number">100</span></span><br><span class="line">db.Save(&amp;user)</span><br><span class="line"><span class="comment">// UPDATE users SET name='jinzhu 2', age=100, birthday='2016-01-01', updated_at = '2013-11-17 21:34:10' WHERE id=111;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="更新单个列" class="article-heading"><a href="#更新单个列" class="headerlink" title="更新单个列"></a>更新单个列<a class="article-anchor" href="#更新单个列" aria-hidden="true"></a></h2><p>当使用 <code>Update</code> 更新单个列时，你需要指定条件，否则会返回 <code>ErrMissingWhereClause</code> 错误，查看 <a href="#block_global_updates">Block Global Updates</a> 获取详情。当使用了 <code>Model</code> 方法，且该对象主键有值，该值会被用于构建条件，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 条件更新</span></span><br><span class="line">db.Model(&amp;User{}).Where(<span class="string">"active = ?"</span>, <span class="literal">true</span>).Update(<span class="string">"name"</span>, <span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE active=true;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// User 的 ID 是 `111`</span></span><br><span class="line">db.Model(&amp;user).Update(<span class="string">"name"</span>, <span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据条件和 model 的值进行更新</span></span><br><span class="line">db.Model(&amp;user).Where(<span class="string">"active = ?"</span>, <span class="literal">true</span>).Update(<span class="string">"name"</span>, <span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111 AND active=true;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="更新多列" class="article-heading"><a href="#更新多列" class="headerlink" title="更新多列"></a>更新多列<a class="article-anchor" href="#更新多列" aria-hidden="true"></a></h2><p><code>Updates</code> 方法支持 <code>struct</code> 和 <code>map[string]interface{}</code> 参数。当使用 <code>struct</code> 更新时，默认情况下，GORM 只会更新非零值的字段</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 根据 `struct` 更新属性，只会更新非零值的字段</span></span><br><span class="line">db.Model(&amp;user).Updates(User{Name: <span class="string">"hello"</span>, Age: <span class="number">18</span>, Active: <span class="literal">false</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18, updated_at = '2013-11-17 21:34:10' WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 `map` 更新属性</span></span><br><span class="line">db.Model(&amp;user).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"active"</span>: <span class="literal">false</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18, active=false, updated_at='2013-11-17 21:34:10' WHERE id=111;</span></span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意</strong> 当通过 struct 更新时，GORM 只会更新非零字段。 如果您想确保指定字段被更新，你应该使用 <code>Select</code> 更新选定字段，或使用 <code>map</code> 来完成更新操作</p></blockquote><h2 id="更新选定字段" class="article-heading"><a href="#更新选定字段" class="headerlink" title="更新选定字段"></a>更新选定字段<a class="article-anchor" href="#更新选定字段" aria-hidden="true"></a></h2><p>如果您想要在更新时选定、忽略某些字段，您可以使用 <code>Select</code>、<code>Omit</code></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 使用 Map 进行 Select</span></span><br><span class="line"><span class="comment">// User's ID is `111`:</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"name"</span>).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"active"</span>: <span class="literal">false</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello' WHERE id=111;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Omit(<span class="string">"name"</span>).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"active"</span>: <span class="literal">false</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET age=18, active=false, updated_at='2013-11-17 21:34:10' WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Struct 进行 Select（会 select 零值的字段）</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"Name"</span>, <span class="string">"Age"</span>).Updates(User{Name: <span class="string">"new_name"</span>, Age: <span class="number">0</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='new_name', age=0 WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Select 所有字段（查询包括零值字段的所有字段）</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"*"</span>).Update(User{Name: <span class="string">"jinzhu"</span>, Role: <span class="string">"admin"</span>, Age: <span class="number">0</span>})</span><br><span class="line"></span><br><span class="line"><span class="comment">// Select 除 Role 外的所有字段（包括零值字段的所有字段）</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"*"</span>).Omit(<span class="string">"Role"</span>).Update(User{Name: <span class="string">"jinzhu"</span>, Role: <span class="string">"admin"</span>, Age: <span class="number">0</span>})</span><br></pre></td></tr></tbody></table></figure><h2 id="更新-Hook" class="article-heading"><a href="#更新-Hook" class="headerlink" title="更新 Hook"></a>更新 Hook<a class="article-anchor" href="#更新-Hook" aria-hidden="true"></a></h2><p>对于更新操作，GORM 支持 <code>BeforeSave</code>、<code>BeforeUpdate</code>、<code>AfterSave</code>、<code>AfterUpdate</code> 钩子，这些方法将在更新记录时被调用，详情请参阅 <a href="hooks.html">钩子</a></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">BeforeUpdate</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> u.Role == <span class="string">"admin"</span> {</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"admin user not allowed to update"</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="批量更新" class="article-heading"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新<a class="article-anchor" href="#批量更新" aria-hidden="true"></a></h2><p>如果您尚未通过 <code>Model</code> 指定记录的主键，则 GORM 会执行批量更新</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 根据 struct 更新</span></span><br><span class="line">db.Model(User{}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Updates(User{Name: <span class="string">"hello"</span>, Age: <span class="number">18</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18 WHERE role = 'admin';</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 map 更新</span></span><br><span class="line">db.Table(<span class="string">"users"</span>).Where(<span class="string">"id IN ?"</span>, []<span class="keyword">int</span>{<span class="number">10</span>, <span class="number">11</span>}).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18 WHERE id IN (10, 11);</span></span><br></pre></td></tr></tbody></table></figure><h3 id="阻止全局更新" class="article-heading"><a href="#阻止全局更新" class="headerlink" title="阻止全局更新"></a><span id="block_global_updates">阻止全局更新</span><a class="article-anchor" href="#阻止全局更新" aria-hidden="true"></a></h3><p>如果在没有任何条件的情况下执行批量更新，默认情况下，GORM 不会执行该操作，并返回 <code>ErrMissingWhereClause</code> 错误</p><p>对此，你必须加一些条件，或者使用原生 SQL，或者启用 <code>AllowGlobalUpdate</code> 模式，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Model(&amp;User{}).Update(<span class="string">"name"</span>, <span class="string">"jinzhu"</span>).Error <span class="comment">// gorm.ErrMissingWhereClause</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{}).Where(<span class="string">"1 = 1"</span>).Update(<span class="string">"name"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET `name` = "jinzhu" WHERE 1=1</span></span><br><span class="line"></span><br><span class="line">db.Exec(<span class="string">"UPDATE users SET name = ?"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name = "jinzhu"</span></span><br><span class="line"></span><br><span class="line">db.Session(&amp;gorm.Session{AllowGlobalUpdate: <span class="literal">true</span>}).Model(&amp;User{}).Update(<span class="string">"name"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET `name` = "jinzhu"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="更新的记录数" class="article-heading"><a href="#更新的记录数" class="headerlink" title="更新的记录数"></a>更新的记录数<a class="article-anchor" href="#更新的记录数" aria-hidden="true"></a></h3><p>获取受更新影响的行数</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 通过 `RowsAffected` 得到更新的记录数</span></span><br><span class="line">result := db.Model(User{}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Updates(User{Name: <span class="string">"hello"</span>, Age: <span class="number">18</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18 WHERE role = 'admin';</span></span><br><span class="line"></span><br><span class="line">result.RowsAffected <span class="comment">// 更新的记录数</span></span><br><span class="line">result.Error        <span class="comment">// 更新的错误</span></span><br></pre></td></tr></tbody></table></figure><h2 id="高级选项" class="article-heading"><a href="#高级选项" class="headerlink" title="高级选项"></a>高级选项<a class="article-anchor" href="#高级选项" aria-hidden="true"></a></h2><h3 id="使用-SQL-表达式更新" class="article-heading"><a href="#使用-SQL-表达式更新" class="headerlink" title="使用 SQL 表达式更新"></a><span id="update_from_sql_expr">使用 SQL 表达式更新</span><a class="article-anchor" href="#使用-SQL-表达式更新" aria-hidden="true"></a></h3><p>GORM 允许使用 SQL 表达式更新列，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// product 的 ID 是 `3`</span></span><br><span class="line">db.Model(&amp;product).Update(<span class="string">"price"</span>, gorm.Expr(<span class="string">"price * ? + ?"</span>, <span class="number">2</span>, <span class="number">100</span>))</span><br><span class="line"><span class="comment">// UPDATE "products" SET "price" = price * 2 + 100, "updated_at" = '2013-11-17 21:34:10' WHERE "id" = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{<span class="string">"price"</span>: gorm.Expr(<span class="string">"price * ? + ?"</span>, <span class="number">2</span>, <span class="number">100</span>)})</span><br><span class="line"><span class="comment">// UPDATE "products" SET "price" = price * 2 + 100, "updated_at" = '2013-11-17 21:34:10' WHERE "id" = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).UpdateColumn(<span class="string">"quantity"</span>, gorm.Expr(<span class="string">"quantity - ?"</span>, <span class="number">1</span>))</span><br><span class="line"><span class="comment">// UPDATE "products" SET "quantity" = quantity - 1 WHERE "id" = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).Where(<span class="string">"quantity &gt; 1"</span>).UpdateColumn(<span class="string">"quantity"</span>, gorm.Expr(<span class="string">"quantity - ?"</span>, <span class="number">1</span>))</span><br><span class="line"><span class="comment">// UPDATE "products" SET "quantity" = quantity - 1 WHERE "id" = 3 AND quantity &gt; 1;</span></span><br></pre></td></tr></tbody></table></figure><p>并且 GORM 也允许使用 SQL 表达式、<a href="data_types.html#gorm_valuer_interface">自定义数据类型</a>的 Context Valuer 来更新，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 根据自定义数据类型创建</span></span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> {</span><br><span class="line">    X, Y <span class="keyword">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc Location)</span> <span class="title">GormValue</span><span class="params">(ctx context.Context, db *gorm.DB)</span> <span class="title">clause</span>.<span class="title">Expr</span></span> {</span><br><span class="line">  <span class="keyword">return</span> clause.Expr{</span><br><span class="line">    SQL:  <span class="string">"ST_PointFromText(?)"</span>,</span><br><span class="line">    Vars: []<span class="keyword">interface</span>{}{fmt.Sprintf(<span class="string">"POINT(%d %d)"</span>, loc.X, loc.Y)},</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>}).Updates(User{</span><br><span class="line">  Name:  <span class="string">"jinzhu"</span>,</span><br><span class="line">  Location: Location{X: <span class="number">100</span>, Y: <span class="number">100</span>},</span><br><span class="line">})</span><br><span class="line"><span class="comment">// UPDATE `user_with_points` SET `name`="jinzhu",`location`=ST_PointFromText("POINT(100 100)") WHERE `id` = 1</span></span><br></pre></td></tr></tbody></table></figure><h3 id="根据子查询进行更新" class="article-heading"><a href="#根据子查询进行更新" class="headerlink" title="根据子查询进行更新"></a>根据子查询进行更新<a class="article-anchor" href="#根据子查询进行更新" aria-hidden="true"></a></h3><p>使用子查询更新表</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Model(&amp;user).Update(<span class="string">"company_name"</span>, db.Model(&amp;Company{}).Select(<span class="string">"name"</span>).Where(<span class="string">"companies.id = users.company_id"</span>))</span><br><span class="line"><span class="comment">// UPDATE "users" SET "company_name" = (SELECT name FROM companies WHERE companies.id = users.company_id);</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">"users as u"</span>).Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Update(<span class="string">"company_name"</span>, db.Table(<span class="string">"companies as c"</span>).Select(<span class="string">"name"</span>).Where(<span class="string">"c.id = u.company_id"</span>))</span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">"users as u"</span>).Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{}{}{<span class="string">"company_name"</span>: db.Table(<span class="string">"companies as c"</span>).Select(<span class="string">"name"</span>).Where(<span class="string">"c.id = u.company_id"</span>)})</span><br></pre></td></tr></tbody></table></figure><h3 id="不使用-Hook-和时间追踪" class="article-heading"><a href="#不使用-Hook-和时间追踪" class="headerlink" title="不使用 Hook 和时间追踪"></a>不使用 Hook 和时间追踪<a class="article-anchor" href="#不使用-Hook-和时间追踪" aria-hidden="true"></a></h3><p>如果您想在更新时跳过 <code>Hook</code> 方法且不追踪更新时间，可以使用 <code>UpdateColumn</code>、<code>UpdateColumns</code>，其用法类似于 <code>Update</code>、<code>Updates</code></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 更新单个列</span></span><br><span class="line">db.Model(&amp;user).UpdateColumn(<span class="string">"name"</span>, <span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello' WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新多个列</span></span><br><span class="line">db.Model(&amp;user).UpdateColumns(User{Name: <span class="string">"hello"</span>, Age: <span class="number">18</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18 WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新选中的列</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"name"</span>, <span class="string">"age"</span>).UpdateColumns(User{Name: <span class="string">"hello"</span>, Age: <span class="number">0</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=0 WHERE id = 111;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="返回修改行的数据" class="article-heading"><a href="#返回修改行的数据" class="headerlink" title="返回修改行的数据"></a>返回修改行的数据<a class="article-anchor" href="#返回修改行的数据" aria-hidden="true"></a></h3><p>返回被修改的数据，仅适用于支持 Returning 的数据库，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 返回所有列</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">DB.Model(&amp;users).Clauses(clause.Returning{}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Update(<span class="string">"salary"</span>, gorm.Expr(<span class="string">"salary * ?"</span>, <span class="number">2</span>))</span><br><span class="line"><span class="comment">// UPDATE `users` SET `salary`=salary * 2,`updated_at`="2021-10-28 17:37:23.19" WHERE role = "admin" RETURNING *</span></span><br><span class="line"><span class="comment">// users =&gt; []User{{ID: 1, Name: "jinzhu", Role: "admin", Salary: 100}, {ID: 2, Name: "jinzhu.2", Role: "admin", Salary: 1000}}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回指定的列</span></span><br><span class="line">DB.Model(&amp;users).Clauses(clause.Returning{Columns: []clause.Column{{Name: <span class="string">"name"</span>}, {Name: <span class="string">"salary"</span>}}}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Update(<span class="string">"salary"</span>, gorm.Expr(<span class="string">"salary * ?"</span>, <span class="number">2</span>))</span><br><span class="line"><span class="comment">// UPDATE `users` SET `salary`=salary * 2,`updated_at`="2021-10-28 17:37:23.19" WHERE role = "admin" RETURNING `name`, `salary`</span></span><br><span class="line"><span class="comment">// users =&gt; []User{{ID: 0, Name: "jinzhu", Role: "", Salary: 100}, {ID: 0, Name: "jinzhu.2", Role: "", Salary: 1000}}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="检查字段是否有变更？" class="article-heading"><a href="#检查字段是否有变更？" class="headerlink" title="检查字段是否有变更？"></a>检查字段是否有变更？<a class="article-anchor" href="#检查字段是否有变更？" aria-hidden="true"></a></h3><p>GORM 提供了 <code>Changed</code> 方法，它可以被用在 <strong>Before Update Hook</strong> 里，它会返回字段是否有变更的布尔值</p><p><code>Changed</code> 方法只能与 <code>Update</code>、<code>Updates</code> 方法一起使用，并且它只是检查 Model 对象字段的值与 <code>Update</code>、<code>Updates</code> 的值是否相等，如果值有变更，且字段没有被忽略，则返回 true</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">BeforeUpdate</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="comment">// 如果 Role 字段有变更</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Changed(<span class="string">"Role"</span>) {</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"role not allowed to change"</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> tx.Statement.Changed(<span class="string">"Name"</span>, <span class="string">"Admin"</span>) { <span class="comment">// 如果 Name 或 Role 字段有变更</span></span><br><span class="line">    tx.Statement.SetColumn(<span class="string">"Age"</span>, <span class="number">18</span>)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果任意字段有变更</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Changed() {</span><br><span class="line">        tx.Statement.SetColumn(<span class="string">"RefreshedAt"</span>, time.Now())</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{<span class="string">"name"</span>: <span class="string">"jinzhu2"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; true</span></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{<span class="string">"name"</span>: <span class="string">"jinzhu"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; false, 因为 `Name` 没有变更</span></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Select(<span class="string">"Admin"</span>).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"jinzhu2"</span>, <span class="string">"admin"</span>: <span class="literal">false</span>,</span><br><span class="line">})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; false, 因为 `Name` 没有被 Select 选中并更新</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Updates(User{Name: <span class="string">"jinzhu2"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; true</span></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Updates(User{Name: <span class="string">"jinzhu"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; false, 因为 `Name` 没有变更</span></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Select(<span class="string">"Admin"</span>).Updates(User{Name: <span class="string">"jinzhu2"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; false, 因为 `Name` 没有被 Select 选中并更新</span></span><br></pre></td></tr></tbody></table></figure><h3 id="在-Update-时修改值" class="article-heading"><a href="#在-Update-时修改值" class="headerlink" title="在 Update 时修改值"></a>在 Update 时修改值<a class="article-anchor" href="#在-Update-时修改值" aria-hidden="true"></a></h3><p>若要在 Before 钩子中改变要更新的值，如果它是一个完整的更新，可以使用 <code>Save</code>；否则，应该使用 <code>SetColumn</code> ，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(user *User)</span> <span class="title">BeforeSave</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> pw, err := bcrypt.GenerateFromPassword(user.Password, <span class="number">0</span>); err == <span class="literal">nil</span> {</span><br><span class="line">    tx.Statement.SetColumn(<span class="string">"EncryptedPassword"</span>, pw)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> tx.Statement.Changed(<span class="string">"Code"</span>) {</span><br><span class="line">    user.Age += <span class="number">20</span></span><br><span class="line">    tx.Statement.SetColumn(<span class="string">"Age"</span>, user.Age)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Update(<span class="string">"Name"</span>, <span class="string">"jinzhu"</span>)</span><br></pre></td></tr></tbody></table></figure></body></html>              </div>
<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">事务</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="禁用默认事务" class="article-heading"><a href="#禁用默认事务" class="headerlink" title="禁用默认事务"></a>禁用默认事务<a class="article-anchor" href="#禁用默认事务" aria-hidden="true"></a></h2><p>为了确保数据一致性，GORM 会在事务里执行写入操作（创建、更新、删除）。如果没有这方面的要求，您可以在初始化时禁用它，这将获得大约 30%+ 性能提升。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 全局禁用</span></span><br><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"gorm.db"</span>), &amp;gorm.Config{</span><br><span class="line">  SkipDefaultTransaction: <span class="literal">true</span>,</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="comment">// 持续会话模式</span></span><br><span class="line">tx := db.Session(&amp;Session{SkipDefaultTransaction: <span class="literal">true</span>})</span><br><span class="line">tx.First(&amp;user, <span class="number">1</span>)</span><br><span class="line">tx.Find(&amp;users)</span><br><span class="line">tx.Model(&amp;user).Update(<span class="string">"Age"</span>, <span class="number">18</span>)</span><br></pre></td></tr></tbody></table></figure><h2 id="事务" class="article-heading"><a href="#事务" class="headerlink" title="事务"></a>事务<a class="article-anchor" href="#事务" aria-hidden="true"></a></h2><p>要在事务中执行一系列操作，一般流程如下：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="comment">// 在事务中执行一些 db 操作（从这里开始，您应该使用 'tx' 而不是 'db'）</span></span><br><span class="line">  <span class="keyword">if</span> err := tx.Create(&amp;Animal{Name: <span class="string">"Giraffe"</span>}).Error; err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="comment">// 返回任何错误都会回滚事务</span></span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := tx.Create(&amp;Animal{Name: <span class="string">"Lion"</span>}).Error; err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 nil 提交事务</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h3 id="嵌套事务" class="article-heading"><a href="#嵌套事务" class="headerlink" title="嵌套事务"></a>嵌套事务<a class="article-anchor" href="#嵌套事务" aria-hidden="true"></a></h3><p>GORM 支持嵌套事务，您可以回滚较大事务内执行的一部分操作，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span> <span class="title">error</span></span> {</span><br><span class="line">  tx.Create(&amp;user1)</span><br><span class="line"></span><br><span class="line">  tx.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span> <span class="title">error</span></span> {</span><br><span class="line">    tx2.Create(&amp;user2)</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"rollback user2"</span>) <span class="comment">// Rollback user2</span></span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  tx.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span> <span class="title">error</span></span> {</span><br><span class="line">    tx2.Create(&amp;user3)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="comment">// Commit user1, user3</span></span><br></pre></td></tr></tbody></table></figure><h2 id="手动事务" class="article-heading"><a href="#手动事务" class="headerlink" title="手动事务"></a>手动事务<a class="article-anchor" href="#手动事务" aria-hidden="true"></a></h2><p>Gorm 支持直接调用事务控制方法（commit、rollback），例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 开始事务</span></span><br><span class="line">tx := db.Begin()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在事务中执行一些 db 操作（从这里开始，您应该使用 'tx' 而不是 'db'）</span></span><br><span class="line">tx.Create(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遇到错误时回滚事务</span></span><br><span class="line">tx.Rollback()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 否则，提交事务</span></span><br><span class="line">tx.Commit()</span><br></pre></td></tr></tbody></table></figure><h3 id="一个特殊的示例" class="article-heading"><a href="#一个特殊的示例" class="headerlink" title="一个特殊的示例"></a>一个特殊的示例<a class="article-anchor" href="#一个特殊的示例" aria-hidden="true"></a></h3><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateAnimals</span><span class="params">(db *gorm.DB)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="comment">// 再唠叨一下，事务一旦开始，你就应该使用 tx 处理数据</span></span><br><span class="line">  tx := db.Begin()</span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> {</span><br><span class="line">      tx.Rollback()</span><br><span class="line">    }</span><br><span class="line">  }()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := tx.Error; err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := tx.Create(&amp;Animal{Name: <span class="string">"Giraffe"</span>}).Error; err != <span class="literal">nil</span> {</span><br><span class="line">     tx.Rollback()</span><br><span class="line">     <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := tx.Create(&amp;Animal{Name: <span class="string">"Lion"</span>}).Error; err != <span class="literal">nil</span> {</span><br><span class="line">     tx.Rollback()</span><br><span class="line">     <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tx.Commit().Error</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="SavePoint、RollbackTo" class="article-heading"><a href="#SavePoint、RollbackTo" class="headerlink" title="SavePoint、RollbackTo"></a>SavePoint、RollbackTo<a class="article-anchor" href="#SavePoint、RollbackTo" aria-hidden="true"></a></h2><p>GORM 提供了 <code>SavePoint</code>、<code>Rollbackto</code> 方法，来提供保存点以及回滚至保存点功能，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">tx := db.Begin()</span><br><span class="line">tx.Create(&amp;user1)</span><br><span class="line"></span><br><span class="line">tx.SavePoint(<span class="string">"sp1"</span>)</span><br><span class="line">tx.Create(&amp;user2)</span><br><span class="line">tx.RollbackTo(<span class="string">"sp1"</span>) <span class="comment">// Rollback user2</span></span><br><span class="line"></span><br><span class="line">tx.Commit() <span class="comment">// Commit user1</span></span><br></pre></td></tr></tbody></table></figure></body></html>              </div>
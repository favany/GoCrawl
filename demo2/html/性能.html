<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">性能</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><p>GORM 已经优化了许多东西来提高性能，其默认性能对大多数应用来说都够用了。但这里还是有一些关于如何为您的应用改进性能的方法。</p><h2 id="禁用默认事务" class="article-heading"><a href="#禁用默认事务" class="headerlink" title="禁用默认事务"></a><a href="transactions.html">禁用默认事务</a><a class="article-anchor" href="#禁用默认事务" aria-hidden="true"></a></h2><p>对于写操作（创建、更新、删除），为了确保数据的完整性，GORM 会将它们封装在事务内运行。但这会降低性能，你可以在初始化时禁用这种方式</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"gorm.db"</span>), &amp;gorm.Config{</span><br><span class="line">  SkipDefaultTransaction: <span class="literal">true</span>,</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h2 id="缓存预编译语句" class="article-heading"><a href="#缓存预编译语句" class="headerlink" title="缓存预编译语句"></a><a href="session.html">缓存预编译语句</a><a class="article-anchor" href="#缓存预编译语句" aria-hidden="true"></a></h2><p>执行任何 SQL 时都创建并缓存预编译语句，可以提高后续的调用速度</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 全局模式</span></span><br><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"gorm.db"</span>), &amp;gorm.Config{</span><br><span class="line">  PrepareStmt: <span class="literal">true</span>,</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="comment">// 会话模式</span></span><br><span class="line">tx := db.Session(&amp;Session{PrepareStmt: <span class="literal">true</span>})</span><br><span class="line">tx.First(&amp;user, <span class="number">1</span>)</span><br><span class="line">tx.Find(&amp;users)</span><br><span class="line">tx.Model(&amp;user).Update(<span class="string">"Age"</span>, <span class="number">18</span>)</span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意</strong> 也可以参考如何为 MySQL 开启 interpolateparams 以减少 roundtrip <a href="https://github.com/go-sql-driver/mysql#interpolateparams" target="_blank" rel="noopener">https://github.com/go-sql-driver/mysql#interpolateparams</a></p></blockquote><h3 id="带-PreparedStmt-的-SQL-生成器" class="article-heading"><a href="#带-PreparedStmt-的-SQL-生成器" class="headerlink" title="带 PreparedStmt 的 SQL 生成器"></a><a href="sql_builder.html">带 PreparedStmt 的 SQL 生成器</a><a class="article-anchor" href="#带-PreparedStmt-的-SQL-生成器" aria-hidden="true"></a></h3><p>Prepared Statement 也可以和原生 SQL 一起使用，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"gorm.db"</span>), &amp;gorm.Config{</span><br><span class="line">  PrepareStmt: <span class="literal">true</span>,</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">db.Raw(<span class="string">"select sum(age) from users where role = ?"</span>, <span class="string">"admin"</span>).Scan(&amp;age)</span><br></pre></td></tr></tbody></table></figure><p>您也可以使用 GORM 的 API <a href="session.html">DryRun 模式</a> 编写 SQL 并执行 prepared statement ，查看 <a href="session.html">会话模式</a> 获取详情</p><h2 id="选择字段" class="article-heading"><a href="#选择字段" class="headerlink" title="选择字段"></a>选择字段<a class="article-anchor" href="#选择字段" aria-hidden="true"></a></h2><p>默认情况下，GORM 在查询时会选择所有的字段，您可以使用 <code>Select</code> 来指定您想要的字段</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Select(<span class="string">"Name"</span>, <span class="string">"Age"</span>).Find(&amp;Users{})</span><br></pre></td></tr></tbody></table></figure><p>或者定义一个较小的 API 结构体，使用 <a href="advanced_query.html">智能选择字段功能</a></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID     <span class="keyword">uint</span></span><br><span class="line">  Name   <span class="keyword">string</span></span><br><span class="line">  Age    <span class="keyword">int</span></span><br><span class="line">  Gender <span class="keyword">string</span></span><br><span class="line">  <span class="comment">// 假设后面还有几百个字段...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> APIUser <span class="keyword">struct</span> {</span><br><span class="line">  ID   <span class="keyword">uint</span></span><br><span class="line">  Name <span class="keyword">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询时会自动选择 `id`、`name` 字段</span></span><br><span class="line">db.Model(&amp;User{}).Limit(<span class="number">10</span>).Find(&amp;APIUser{})</span><br><span class="line"><span class="comment">// SELECT `id`, `name` FROM `users` LIMIT 10</span></span><br></pre></td></tr></tbody></table></figure><h2 id="迭代、FindInBatches" class="article-heading"><a href="#迭代、FindInBatches" class="headerlink" title="迭代、FindInBatches"></a><a href="advanced_query.html">迭代、FindInBatches</a><a class="article-anchor" href="#迭代、FindInBatches" aria-hidden="true"></a></h2><p>用迭代或 in batches 查询并处理记录</p><h2 id="Index-Hints" class="article-heading"><a href="#Index-Hints" class="headerlink" title="Index Hints"></a><a href="hints.html">Index Hints</a><a class="article-anchor" href="#Index-Hints" aria-hidden="true"></a></h2><p><a href="indexes.html">Index</a> 用于提高数据检索和 SQL 查询性能。 <code>Index Hints</code> 向优化器提供了在查询处理过程中如何选择索引的信息。与 optimizer 相比，它可以更灵活地选择更有效的执行计划</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/hints"</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.UseIndex(<span class="string">"idx_user_name"</span>)).Find(&amp;User{})</span><br><span class="line"><span class="comment">// SELECT * FROM `users` USE INDEX (`idx_user_name`)</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.ForceIndex(<span class="string">"idx_user_name"</span>, <span class="string">"idx_user_id"</span>).ForJoin()).Find(&amp;User{})</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FORCE INDEX FOR JOIN (`idx_user_name`,`idx_user_id`)"</span></span><br><span class="line"></span><br><span class="line">db.Clauses(</span><br><span class="line">    hints.ForceIndex(<span class="string">"idx_user_name"</span>, <span class="string">"idx_user_id"</span>).ForOrderBy(),</span><br><span class="line">    hints.IgnoreIndex(<span class="string">"idx_user_name"</span>).ForGroupBy(),</span><br><span class="line">).Find(&amp;User{})</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FORCE INDEX FOR ORDER BY (`idx_user_name`,`idx_user_id`) IGNORE INDEX FOR GROUP BY (`idx_user_name`)"</span></span><br></pre></td></tr></tbody></table></figure><h2 id="读写分离" class="article-heading"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离<a class="article-anchor" href="#读写分离" aria-hidden="true"></a></h2><p>通过读写分离提高数据吞吐量，查看 <a href="dbresolver.html">Database Resolver</a> 获取详情</p></body></html>              </div>
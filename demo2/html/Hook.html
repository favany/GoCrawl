<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">Hook</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="对象生命周期" class="article-heading"><a href="#对象生命周期" class="headerlink" title="对象生命周期"></a>对象生命周期<a class="article-anchor" href="#对象生命周期" aria-hidden="true"></a></h2><p>Hook 是在创建、查询、更新、删除等操作之前、之后调用的函数。</p><p>如果您已经为模型定义了指定的方法，它会在创建、更新、查询、删除时自动被调用。如果任何回调返回错误，GORM 将停止后续的操作并回滚事务。</p><p>钩子方法的函数签名应该是 <code>func(*gorm.DB) error</code></p><h2 id="Hook" class="article-heading"><a href="#Hook" class="headerlink" title="Hook"></a>Hook<a class="article-anchor" href="#Hook" aria-hidden="true"></a></h2><h3 id="创建对象" class="article-heading"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象<a class="article-anchor" href="#创建对象" aria-hidden="true"></a></h3><p>创建时可用的 hook</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 开始事务</span></span><br><span class="line">BeforeSave</span><br><span class="line">BeforeCreate</span><br><span class="line"><span class="comment">// 关联前的 save</span></span><br><span class="line"><span class="comment">// 插入记录至 db</span></span><br><span class="line"><span class="comment">// 关联后的 save</span></span><br><span class="line">AfterCreate</span><br><span class="line">AfterSave</span><br><span class="line"><span class="comment">// 提交或回滚事务</span></span><br></pre></td></tr></tbody></table></figure><p>代码示例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">BeforeCreate</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  u.UUID = uuid.New()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> !u.IsValid() {</span><br><span class="line">    err = errors.New(<span class="string">"can't save invalid data"</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">AfterCreate</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> u.ID == <span class="number">1</span> {</span><br><span class="line">    tx.Model(u).Update(<span class="string">"role"</span>, <span class="string">"admin"</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意</strong> 在 GORM 中保存、删除操作会默认运行在事务上， 因此在事务完成之前该事务中所作的更改是不可见的，如果您的钩子返回了任何错误，则修改将被回滚。</p></blockquote><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">AfterCreate</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> !u.IsValid() {</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"rollback invalid user"</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="更新对象" class="article-heading"><a href="#更新对象" class="headerlink" title="更新对象"></a>更新对象<a class="article-anchor" href="#更新对象" aria-hidden="true"></a></h3><p>更新时可用的 hook</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 开始事务</span></span><br><span class="line">BeforeSave</span><br><span class="line">BeforeUpdate</span><br><span class="line"><span class="comment">// 关联前的 save</span></span><br><span class="line"><span class="comment">// 更新 db</span></span><br><span class="line"><span class="comment">// 关联后的 save</span></span><br><span class="line">AfterUpdate</span><br><span class="line">AfterSave</span><br><span class="line"><span class="comment">// 提交或回滚事务</span></span><br></pre></td></tr></tbody></table></figure><p>代码示例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">BeforeUpdate</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> u.readonly() {</span><br><span class="line">    err = errors.New(<span class="string">"read only user"</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在同一个事务中更新数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">AfterUpdate</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> u.Confirmed {</span><br><span class="line">    tx.Model(&amp;Address{}).Where(<span class="string">"user_id = ?"</span>, u.ID).Update(<span class="string">"verfied"</span>, <span class="literal">true</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="删除对象" class="article-heading"><a href="#删除对象" class="headerlink" title="删除对象"></a>删除对象<a class="article-anchor" href="#删除对象" aria-hidden="true"></a></h3><p>删除时可用的 hook</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 开始事务</span></span><br><span class="line">BeforeDelete</span><br><span class="line"><span class="comment">// 删除 db 中的数据</span></span><br><span class="line">AfterDelete</span><br><span class="line"><span class="comment">// 提交或回滚事务</span></span><br></pre></td></tr></tbody></table></figure><p>代码示例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 在同一个事务中更新数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">AfterDelete</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> u.Confirmed {</span><br><span class="line">    tx.Model(&amp;Address{}).Where(<span class="string">"user_id = ?"</span>, u.ID).Update(<span class="string">"invalid"</span>, <span class="literal">false</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="查询对象" class="article-heading"><a href="#查询对象" class="headerlink" title="查询对象"></a>查询对象<a class="article-anchor" href="#查询对象" aria-hidden="true"></a></h3><p>查询时可用的 hook</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 从 db 中加载数据</span></span><br><span class="line"><span class="comment">// Preloading (eager loading)</span></span><br><span class="line">AfterFind</span><br></pre></td></tr></tbody></table></figure><p>代码示例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">AfterFind</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> u.MemberShip == <span class="string">""</span> {</span><br><span class="line">    u.MemberShip = <span class="string">"user"</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="修改当前操作" class="article-heading"><a href="#修改当前操作" class="headerlink" title="修改当前操作"></a>修改当前操作<a class="article-anchor" href="#修改当前操作" aria-hidden="true"></a></h2><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">BeforeCreate</span><span class="params">(tx *gorm.DB)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="comment">// 通过 tx.Statement 修改当前操作，例如：</span></span><br><span class="line">  tx.Statement.Select(<span class="string">"Name"</span>, <span class="string">"Age"</span>)</span><br><span class="line">  tx.Statement.AddClause(clause.OnConflict{DoNothing: <span class="literal">true</span>})</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tx 是带有 `NewDB` 选项的新会话模式 </span></span><br><span class="line">  <span class="comment">// 基于 tx 的操作会在同一个事务中，但不会带上任何当前的条件</span></span><br><span class="line">  err := tx.First(&amp;role, <span class="string">"name = ?"</span>, user.Role).Error</span><br><span class="line">  <span class="comment">// SELECT * FROM roles WHERE name = "admin"</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></body></html>              </div>
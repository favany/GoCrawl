<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">预加载</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="预加载" class="article-heading"><a href="#预加载" class="headerlink" title="预加载"></a>预加载<a class="article-anchor" href="#预加载" aria-hidden="true"></a></h2><p>GORM 允许在 <code>Preload</code> 的其它 SQL 中直接加载关系，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Username <span class="keyword">string</span></span><br><span class="line">  Orders   []Order</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  UserID <span class="keyword">uint</span></span><br><span class="line">  Price  <span class="keyword">float64</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找 user 时预加载相关 Order</span></span><br><span class="line">db.Preload(<span class="string">"Orders"</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users;</span></span><br><span class="line"><span class="comment">// SELECT * FROM orders WHERE user_id IN (1,2,3,4);</span></span><br><span class="line"></span><br><span class="line">db.Preload(<span class="string">"Orders"</span>).Preload(<span class="string">"Profile"</span>).Preload(<span class="string">"Role"</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users;</span></span><br><span class="line"><span class="comment">// SELECT * FROM orders WHERE user_id IN (1,2,3,4); // has many</span></span><br><span class="line"><span class="comment">// SELECT * FROM profiles WHERE user_id IN (1,2,3,4); // has one</span></span><br><span class="line"><span class="comment">// SELECT * FROM roles WHERE id IN (4,5,6); // belongs to</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Joins-预加载" class="article-heading"><a href="#Joins-预加载" class="headerlink" title="Joins 预加载"></a>Joins 预加载<a class="article-anchor" href="#Joins-预加载" aria-hidden="true"></a></h2><p><code>Preload</code> 在一个单独查询中加载关联数据。而 <code>Join Preload</code> 会使用 inner join 加载关联数据，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Joins(<span class="string">"Company"</span>).Joins(<span class="string">"Manager"</span>).Joins(<span class="string">"Account"</span>).First(&amp;user, <span class="number">1</span>)</span><br><span class="line">db.Joins(<span class="string">"Company"</span>).Joins(<span class="string">"Manager"</span>).Joins(<span class="string">"Account"</span>).First(&amp;user, <span class="string">"users.name = ?"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line">db.Joins(<span class="string">"Company"</span>).Joins(<span class="string">"Manager"</span>).Joins(<span class="string">"Account"</span>).Find(&amp;users, <span class="string">"users.id IN ?"</span>, []<span class="keyword">int</span>{<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>})</span><br></pre></td></tr></tbody></table></figure><p>带条件的 Join</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Joins(<span class="string">"Company"</span>, DB.Where(&amp;Company{Alive: <span class="literal">true</span>})).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id` AND `Company`.`alive` = true;</span></span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意</strong> <code>Join Preload</code> 适用于一对一的关系，例如： <code>has one</code>, <code>belongs to</code></p></blockquote><h2 id="预加载全部" class="article-heading"><a href="#预加载全部" class="headerlink" title="预加载全部"></a>预加载全部<a class="article-anchor" href="#预加载全部" aria-hidden="true"></a></h2><p>与创建、更新时使用 <code>Select</code> 类似，<code>clause.Associations</code> 也可以和 <code>Preload</code> 一起使用，它可以用来 <code>预加载</code> 全部关联，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name       <span class="keyword">string</span></span><br><span class="line">  CompanyID  <span class="keyword">uint</span></span><br><span class="line">  Company    Company</span><br><span class="line">  Role       Role</span><br><span class="line">  Orders     []Order</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Preload(clause.Associations).Find(&amp;users)</span><br></pre></td></tr></tbody></table></figure><p><code>clause.Associations</code> 不会预加载嵌套的关联，但你可以使用<a href="#nested_preloading">嵌套预加载</a> 例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Preload(<span class="string">"Orders.OrderItems.Product"</span>).Preload(clause.Associations).Find(&amp;users)</span><br></pre></td></tr></tbody></table></figure><h2 id="带条件的预加载" class="article-heading"><a href="#带条件的预加载" class="headerlink" title="带条件的预加载"></a>带条件的预加载<a class="article-anchor" href="#带条件的预加载" aria-hidden="true"></a></h2><p>GORM 允许带条件的 Preload 关联，类似于<a href="query.html#inline_conditions">内联条件</a></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 带条件的预加载 Order</span></span><br><span class="line">db.Preload(<span class="string">"Orders"</span>, <span class="string">"state NOT IN (?)"</span>, <span class="string">"cancelled"</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users;</span></span><br><span class="line"><span class="comment">// SELECT * FROM orders WHERE user_id IN (1,2,3,4) AND state NOT IN ('cancelled');</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">"state = ?"</span>, <span class="string">"active"</span>).Preload(<span class="string">"Orders"</span>, <span class="string">"state NOT IN (?)"</span>, <span class="string">"cancelled"</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE state = 'active';</span></span><br><span class="line"><span class="comment">// SELECT * FROM orders WHERE user_id IN (1,2) AND state NOT IN ('cancelled');</span></span><br></pre></td></tr></tbody></table></figure><h2 id="自定义预加载-SQL" class="article-heading"><a href="#自定义预加载-SQL" class="headerlink" title="自定义预加载 SQL"></a>自定义预加载 SQL<a class="article-anchor" href="#自定义预加载-SQL" aria-hidden="true"></a></h2><p>您可以通过 <code>func(db *gorm.DB) *gorm.DB</code> 实现自定义预加载 SQL，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Preload(<span class="string">"Orders"</span>, <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> db.Order(<span class="string">"orders.amount DESC"</span>)</span><br><span class="line">}).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users;</span></span><br><span class="line"><span class="comment">// SELECT * FROM orders WHERE user_id IN (1,2,3,4) order by orders.amount DESC;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="嵌套预加载" class="article-heading"><a href="#嵌套预加载" class="headerlink" title="嵌套预加载"></a><span id="nested_preloading">嵌套预加载</span><a class="article-anchor" href="#嵌套预加载" aria-hidden="true"></a></h2><p>GORM 支持嵌套预加载，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Preload(<span class="string">"Orders.OrderItems.Product"</span>).Preload(<span class="string">"CreditCard"</span>).Find(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义预加载 `Orders` 的条件</span></span><br><span class="line"><span class="comment">// 这样，GORM 就不会加载不匹配的 order 记录</span></span><br><span class="line">db.Preload(<span class="string">"Orders"</span>, <span class="string">"state = ?"</span>, <span class="string">"paid"</span>).Preload(<span class="string">"Orders.OrderItems"</span>).Find(&amp;users)</span><br></pre></td></tr></tbody></table></figure></body></html>              </div>
<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">连接到数据库</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><p>GORM 官方支持的数据库类型有： MySQL, PostgreSQL, SQlite, SQL Server</p><h2 id="MySQL" class="article-heading"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL<a class="article-anchor" href="#MySQL" aria-hidden="true"></a></h2><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"gorm.io/driver/mysql"</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="comment">// 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情</span></span><br><span class="line">  dsn := <span class="string">"user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span></span><br><span class="line">  db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意：</strong>想要正确的处理 <code>time.Time</code> ，您需要带上 <code>parseTime</code> 参数， (<a href="https://github.com/go-sql-driver/mysql#parameters" target="_blank" rel="noopener">更多参数</a>) 要支持完整的 UTF-8 编码，您需要将 <code>charset=utf8</code> 更改为 <code>charset=utf8mb4</code> 查看 <a href="https://mathiasbynens.be/notes/mysql-utf8mb4" target="_blank" rel="noopener">此文章</a> 获取详情</p></blockquote><p>MySQl 驱动程序提供了 <a href="https://github.com/go-gorm/mysql" target="_blank" rel="noopener">一些高级配置</a> 可以在初始化过程中使用，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(mysql.New(mysql.Config{</span><br><span class="line">  DSN: <span class="string">"gorm:gorm@tcp(127.0.0.1:3306)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local"</span>, <span class="comment">// DSN data source name</span></span><br><span class="line">  DefaultStringSize: <span class="number">256</span>, <span class="comment">// string 类型字段的默认长度</span></span><br><span class="line">  DisableDatetimePrecision: <span class="literal">true</span>, <span class="comment">// 禁用 datetime 精度，MySQL 5.6 之前的数据库不支持</span></span><br><span class="line">  DontSupportRenameIndex: <span class="literal">true</span>, <span class="comment">// 重命名索引时采用删除并新建的方式，MySQL 5.7 之前的数据库和 MariaDB 不支持重命名索引</span></span><br><span class="line">  DontSupportRenameColumn: <span class="literal">true</span>, <span class="comment">// 用 `change` 重命名列，MySQL 8 之前的数据库和 MariaDB 不支持重命名列</span></span><br><span class="line">  SkipInitializeWithVersion: <span class="literal">false</span>, <span class="comment">// 根据当前 MySQL 版本自动配置</span></span><br><span class="line">}), &amp;gorm.Config{})</span><br></pre></td></tr></tbody></table></figure><h3 id="自定义驱动" class="article-heading"><a href="#自定义驱动" class="headerlink" title="自定义驱动"></a>自定义驱动<a class="article-anchor" href="#自定义驱动" aria-hidden="true"></a></h3><p>GORM 允许通过 <code>DriverName</code> 选项自定义 MySQL 驱动，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  _ <span class="string">"example.com/my_mysql_driver"</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db, err := gorm.Open(mysql.New(mysql.Config{</span><br><span class="line">  DriverName: <span class="string">"my_mysql_driver"</span>,</span><br><span class="line">  DSN: <span class="string">"gorm:gorm@tcp(localhost:9910)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local"</span>, <span class="comment">// Data Source Name，参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name</span></span><br><span class="line">}), &amp;gorm.Config{})</span><br></pre></td></tr></tbody></table></figure><h3 id="现有的数据库连接" class="article-heading"><a href="#现有的数据库连接" class="headerlink" title="现有的数据库连接"></a>现有的数据库连接<a class="article-anchor" href="#现有的数据库连接" aria-hidden="true"></a></h3><p>GORM 允许通过一个现有的数据库连接来初始化 <code>*gorm.DB</code></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"database/sql"</span></span><br><span class="line">  <span class="string">"gorm.io/driver/mysql"</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sqlDB, err := sql.Open(<span class="string">"mysql"</span>, <span class="string">"mydb_dsn"</span>)</span><br><span class="line">gormDB, err := gorm.Open(mysql.New(mysql.Config{</span><br><span class="line">  Conn: sqlDB,</span><br><span class="line">}), &amp;gorm.Config{})</span><br></pre></td></tr></tbody></table></figure><h2 id="PostgreSQL" class="article-heading"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL<a class="article-anchor" href="#PostgreSQL" aria-hidden="true"></a></h2><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"gorm.io/driver/postgres"</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">dsn := <span class="string">"host=localhost user=gorm password=gorm dbname=gorm port=9920 sslmode=disable TimeZone=Asia/Shanghai"</span></span><br><span class="line">db, err := gorm.Open(postgres.Open(dsn), &amp;gorm.Config{})</span><br></pre></td></tr></tbody></table></figure><p>我们使用 <a href="https://github.com/jackc/pgx" target="_blank" rel="noopener">pgx</a> 作为 postgres 的 database/sql 驱动，默认情况下，它会启用 prepared statement 缓存，你可以这样禁用它：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// https://github.com/go-gorm/postgres</span></span><br><span class="line">db, err := gorm.Open(postgres.New(postgres.Config{</span><br><span class="line">  DSN: <span class="string">"user=gorm password=gorm dbname=gorm port=9920 sslmode=disable TimeZone=Asia/Shanghai"</span>,</span><br><span class="line">  PreferSimpleProtocol: <span class="literal">true</span>, <span class="comment">// disables implicit prepared statement usage</span></span><br><span class="line">}), &amp;gorm.Config{})</span><br></pre></td></tr></tbody></table></figure><h3 id="自定义驱动-1" class="article-heading"><a href="#自定义驱动-1" class="headerlink" title="自定义驱动"></a>自定义驱动<a class="article-anchor" href="#自定义驱动-1" aria-hidden="true"></a></h3><p>GORM 允许通过 <code>DriverName</code> 选项自定义 PostgreSQL 驱动，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  _ <span class="string">"github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/dialers/postgres"</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db, err := gorm.Open(postgres.New(postgres.Config{</span><br><span class="line">  DriverName: <span class="string">"cloudsqlpostgres"</span>,</span><br><span class="line">  DSN: <span class="string">"host=project:region:instance user=postgres dbname=postgres password=password sslmode=disable"</span>,</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h3 id="现有的数据库连接-1" class="article-heading"><a href="#现有的数据库连接-1" class="headerlink" title="现有的数据库连接"></a>现有的数据库连接<a class="article-anchor" href="#现有的数据库连接-1" aria-hidden="true"></a></h3><p>GORM 允许通过一个现有的数据库连接来初始化 <code>*gorm.DB</code></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"database/sql"</span></span><br><span class="line">  <span class="string">"gorm.io/driver/postgres"</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sqlDB, err := sql.Open(<span class="string">"pgx"</span>, <span class="string">"mydb_dsn"</span>)</span><br><span class="line">gormDB, err := gorm.Open(postgres.New(postgres.Config{</span><br><span class="line">  Conn: sqlDB,</span><br><span class="line">}), &amp;gorm.Config{})</span><br></pre></td></tr></tbody></table></figure><h2 id="SQLite" class="article-heading"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite<a class="article-anchor" href="#SQLite" aria-hidden="true"></a></h2><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"gorm.io/driver/sqlite"</span> <span class="comment">// Sqlite driver based on GGO</span></span><br><span class="line">  <span class="comment">// "github.com/glebarez/sqlite" // Pure go SQLite driver, checkout https://github.com/glebarez/sqlite for details</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// github.com/mattn/go-sqlite3</span></span><br><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"gorm.db"</span>), &amp;gorm.Config{})</span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意：</strong> 您也可以使用 <code>file::memory:?cache=shared</code> 替代文件路径。 这会告诉 SQLite 在系统内存中使用一个临时数据库。 (查看 <a href="https://www.sqlite.org/inmemorydb.html" target="_blank" rel="noopener">SQLite 文档</a> 获取详情)</p></blockquote><h2 id="SQL-Server" class="article-heading"><a href="#SQL-Server" class="headerlink" title="SQL Server"></a>SQL Server<a class="article-anchor" href="#SQL-Server" aria-hidden="true"></a></h2><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"gorm.io/driver/sqlserver"</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// github.com/denisenkom/go-mssqldb</span></span><br><span class="line">dsn := <span class="string">"sqlserver://gorm:LoremIpsum86@localhost:9930?database=gorm"</span></span><br><span class="line">db, err := gorm.Open(sqlserver.Open(dsn), &amp;gorm.Config{})</span><br></pre></td></tr></tbody></table></figure><h2 id="Clickhouse" class="article-heading"><a href="#Clickhouse" class="headerlink" title="Clickhouse"></a>Clickhouse<a class="article-anchor" href="#Clickhouse" aria-hidden="true"></a></h2><p><a href="https://github.com/go-gorm/clickhouse" target="_blank" rel="noopener">https://github.com/go-gorm/clickhouse</a></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"gorm.io/driver/clickhouse"</span></span><br><span class="line">  <span class="string">"gorm.io/gorm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">  dsn := <span class="string">"tcp://localhost:9000?database=gorm&amp;username=gorm&amp;password=gorm&amp;read_timeout=10&amp;write_timeout=20"</span></span><br><span class="line">  db, err := gorm.Open(clickhouse.Open(dsn), &amp;gorm.Config{})</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Auto Migrate</span></span><br><span class="line">  db.AutoMigrate(&amp;User{})</span><br><span class="line">  <span class="comment">// Set table options</span></span><br><span class="line">  db.Set(<span class="string">"gorm:table_options"</span>, <span class="string">"ENGINE=Distributed(cluster, default, hits)"</span>).AutoMigrate(&amp;User{})</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 插入</span></span><br><span class="line">  db.Create(&amp;user)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询</span></span><br><span class="line">  db.Find(&amp;user, <span class="string">"id = ?"</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量插入</span></span><br><span class="line">  <span class="keyword">var</span> users = []User{user1, user2, user3}</span><br><span class="line">  db.Create(&amp;users)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="连接池" class="article-heading"><a href="#连接池" class="headerlink" title="连接池"></a>连接池<a class="article-anchor" href="#连接池" aria-hidden="true"></a></h2><p>GORM 使用 <a href="https://pkg.go.dev/database/sql" target="_blank" rel="noopener">database/sql</a> 维护连接池</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">sqlDB, err := db.DB()</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetMaxIdleConns 设置空闲连接池中连接的最大数量</span></span><br><span class="line">sqlDB.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetMaxOpenConns 设置打开数据库连接的最大数量。</span></span><br><span class="line">sqlDB.SetMaxOpenConns(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetConnMaxLifetime 设置了连接可复用的最大时间。</span></span><br><span class="line">sqlDB.SetConnMaxLifetime(time.Hour)</span><br></pre></td></tr></tbody></table></figure><p>查看 <a href="generic_interface.html">通用接口</a> 获取详情。</p><h2 id="不支持的数据库" class="article-heading"><a href="#不支持的数据库" class="headerlink" title="不支持的数据库"></a>不支持的数据库<a class="article-anchor" href="#不支持的数据库" aria-hidden="true"></a></h2><p>有些数据库可能兼容 <code>mysql</code>、<code>postgres</code> 的方言，在这种情况下，你可以直接使用这些数据库的方言。</p><p>对于其它不支持的数据，<a href="write_driver.html">我们鼓励且欢迎大家伙开发更多数据库类型的驱动！</a></p></body></html>              </div>
<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">Scopes</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><p>作用域允许你复用通用的逻辑，这种共享逻辑需要定义为类型<code>func(*gorm.DB) *gorm.DB</code>。</p><h2 id="查询" class="article-heading"><a href="#查询" class="headerlink" title="查询"></a>查询<a class="article-anchor" href="#查询" aria-hidden="true"></a></h2><p>Scope 查询示例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AmountGreaterThan1000</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">"amount &gt; ?"</span>, <span class="number">1000</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PaidWithCreditCard</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">"pay_mode_sign = ?"</span>, <span class="string">"C"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PaidWithCod</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">"pay_mode_sign = ?"</span>, <span class="string">"C"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OrderStatus</span><span class="params">(status []<span class="keyword">string</span>)</span> <span class="title">func</span> <span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span> <span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">    <span class="keyword">return</span> db.Where(<span class="string">"status IN (?)"</span>, status)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, PaidWithCreditCard).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于 1000 的信用卡订单</span></span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, PaidWithCod).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于 1000 的 COD 订单</span></span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, OrderStatus([]<span class="keyword">string</span>{<span class="string">"paid"</span>, <span class="string">"shipped"</span>})).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于1000 的已付款或已发货订单</span></span><br></pre></td></tr></tbody></table></figure><h3 id="分页" class="article-heading"><a href="#分页" class="headerlink" title="分页"></a><span id="pagination">分页</span><a class="article-anchor" href="#分页" aria-hidden="true"></a></h3><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Paginate</span><span class="params">(r *http.Request)</span> <span class="title">func</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span> <span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">    q := r.URL.Query()</span><br><span class="line">    page, _ := strconv.Atoi(q.Get(<span class="string">"page"</span>))</span><br><span class="line">    <span class="keyword">if</span> page == <span class="number">0</span> {</span><br><span class="line">      page = <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    pageSize, _ := strconv.Atoi(q.Get(<span class="string">"page_size"</span>))</span><br><span class="line">    <span class="keyword">switch</span> {</span><br><span class="line">    <span class="keyword">case</span> pageSize &gt; <span class="number">100</span>:</span><br><span class="line">      pageSize = <span class="number">100</span></span><br><span class="line">    <span class="keyword">case</span> pageSize &lt;= <span class="number">0</span>:</span><br><span class="line">      pageSize = <span class="number">10</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    offset := (page - <span class="number">1</span>) * pageSize</span><br><span class="line">    <span class="keyword">return</span> db.Offset(offset).Limit(pageSize)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Scopes(Paginate(r)).Find(&amp;users)</span><br><span class="line">db.Scopes(Paginate(r)).Find(&amp;articles)</span><br></pre></td></tr></tbody></table></figure><h2 id="动态表" class="article-heading"><a href="#动态表" class="headerlink" title="动态表"></a>动态表<a class="article-anchor" href="#动态表" aria-hidden="true"></a></h2><p>使用 <code>Scopes</code> 来动态指定查询的表</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TableOfYear</span><span class="params">(user *User, year <span class="keyword">int</span>)</span> <span class="title">func</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">        tableName := user.TableName() + strconv.Itoa(year)</span><br><span class="line">        <span class="keyword">return</span> db.Table(tableName)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">DB.Scopes(TableOfYear(user, <span class="number">2019</span>)).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users_2019;</span></span><br><span class="line"></span><br><span class="line">DB.Scopes(TableOfYear(user, <span class="number">2020</span>)).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users_2020;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Table form different database</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TableOfOrg</span><span class="params">(user *User, dbName <span class="keyword">string</span>)</span> <span class="title">func</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">        tableName := dbName + <span class="string">"."</span> + user.TableName()</span><br><span class="line">        <span class="keyword">return</span> db.Table(tableName)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">DB.Scopes(TableOfOrg(user, <span class="string">"org1"</span>)).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM org1.users;</span></span><br><span class="line"></span><br><span class="line">DB.Scopes(TableOfOrg(user, <span class="string">"org2"</span>)).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM org2.users;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="更新" class="article-heading"><a href="#更新" class="headerlink" title="更新"></a>更新<a class="article-anchor" href="#更新" aria-hidden="true"></a></h2><p>Scope 更新、删除示例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CurOrganization</span><span class="params">(r *http.Request)</span> <span class="title">func</span><span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span> <span class="params">(db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> {</span><br><span class="line">    org := r.Query(<span class="string">"org"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> org != <span class="string">""</span> {</span><br><span class="line">      <span class="keyword">var</span> organization Organization</span><br><span class="line">      <span class="keyword">if</span> db.Session(&amp;Session{}).First(&amp;organization, <span class="string">"name = ?"</span>, org).Error == <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">return</span> db.Where(<span class="string">"org_id = ?"</span>, organization.ID)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    db.AddError(<span class="string">"invalid organization"</span>)</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Model(&amp;article).Scopes(CurOrganization(r)).Update(<span class="string">"Name"</span>, <span class="string">"name 1"</span>)</span><br><span class="line"><span class="comment">// UPDATE articles SET name = "name 1" WHERE org_id = 111</span></span><br><span class="line">db.Scopes(CurOrganization(r)).Delete(&amp;Article{})</span><br><span class="line"><span class="comment">// DELETE FROM articles WHERE org_id = 111</span></span><br></pre></td></tr></tbody></table></figure></body></html>              </div>